{% extends "layout.html" %}
{% load static %}

{% block title %}Window of Tolerance{% endblock %}

{% block content %}
<main class="main-layout tolerance-centered-layout">
  <section class="toolkit-column tolerance-page">
    <div class="tolerance-content">

      <div class="panel-header">
        <div class="panel-heading">
          <h1>Window of Tolerance</h1>
          <p class="panel-subtitle">{{ checkin.date }}</p>
        </div>

        <div class="panel-actions">
          <div class="new-chat-btn" style="pointer-events:none;">
            <span id="todayLabel">{{ summary.today_label }}</span>
          </div>
        </div>
      </div>

      <div class="score-grid">
        <div class="score-card" style="--hue: 10">
          <div class="score-card__icon">üî•</div>
          <div class="score-card__value" id="cHyper">{{ summary.counts.hyper }}</div>
          <div class="score-card__label">Hyper</div>
          <div class="score-card__hint">Activated</div>
        </div>

        <div class="score-card" style="--hue: 120">
          <div class="score-card__icon">üü¢</div>
          <div class="score-card__value" id="cWindow">{{ summary.counts.window }}</div>
          <div class="score-card__label">Window</div>
          <div class="score-card__hint">Regulated</div>
        </div>

        <div class="score-card" style="--hue: 210">
          <div class="score-card__icon">‚ùÑÔ∏è</div>
          <div class="score-card__value" id="cHypo">{{ summary.counts.hypo }}</div>
          <div class="score-card__label">Hypo</div>
          <div class="score-card__hint">Shut down</div>
        </div>

        <div class="score-card" style="--hue: 260">
          <div class="score-card__icon">‚≠ê</div>
          <div class="score-card__value" id="score">{{ summary.score }}</div>
          <div class="score-card__label">Score</div>
          <div class="score-card__hint">Window - Others</div>
        </div>
      </div>

      <h3>Keywords</h3>
      <div id="keywordBank">
        {% csrf_token %}
        {% for kw in keywords %}
          <button
            type="button"
            class="chip {% if kw.id in selected %}selected{% endif %}"
            data-kid="{{ kw.id }}"
          >
            {{ kw.label }}
          </button>
        {% endfor %}
      </div>

      <div class="grid">
        <div class="flashcard">
          <div class="card-title">Hyper-arousal</div>
          <div id="listHYPER">
            {% for k in selected_keywords %}
              {% if k.default_zone == "HYPER" %}
                <span class="pill">{{ k.label }}</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="flashcard">
          <div class="card-title">Window of tolerance</div>
          <div id="listWINDOW">
            {% for k in selected_keywords %}
              {% if k.default_zone == "WINDOW" %}
                <span class="pill">{{ k.label }}</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="flashcard">
          <div class="card-title">Hypo-arousal</div>
          <div id="listHYPO">
            {% for k in selected_keywords %}
              {% if k.default_zone == "HYPO" %}
                <span class="pill">{{ k.label }}</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

function renderPills(containerId, labels) {
  const el = document.getElementById(containerId);
  el.textContent = labels.join("; ");
}

  function updateSummary(summary) {
    document.getElementById("todayLabel").textContent = summary.today_label;
    document.getElementById("cHyper").textContent = summary.counts.hyper;
    document.getElementById("cWindow").textContent = summary.counts.window;
    document.getElementById("cHypo").textContent = summary.counts.hypo;
    document.getElementById("score").textContent = summary.score;
  }

  document.getElementById("keywordBank").addEventListener("click", async (e) => {
    if (!e.target.classList.contains("chip")) return;

    const keywordId = e.target.dataset.kid;

    const resp = await fetch("{% url 'tolerance:toggle_keyword' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken
      },
      body: new URLSearchParams({ keyword_id: keywordId })
    });

    const data = await resp.json();
    if (!data.ok) return;

    const selectedIds = new Set(data.selected_ids.map(String));
    document.querySelectorAll(".chip").forEach(btn => {
      btn.classList.toggle("selected", selectedIds.has(btn.dataset.kid));
    });

    renderPills("listHYPER", data.grouped.HYPER || []);
    renderPills("listWINDOW", data.grouped.WINDOW || []);
    renderPills("listHYPO", data.grouped.HYPO || []);

    updateSummary(data.summary);
  });

</script>
{% endblock %}


